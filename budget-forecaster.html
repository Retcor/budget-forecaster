<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget & Debt Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-chart-line mr-2"></i>FinanceForecaster</h1>
            <div class="text-sm opacity-80">Local Storage Enabled</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        
        <!-- LEFT PANEL: Inputs -->
        <div class="w-full lg:w-1/3 space-y-6 overflow-y-auto h-auto lg:h-[calc(100vh-100px)] pr-2">
            
            <!-- Income Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-wallet text-green-500 mr-2"></i>Income Setup</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Paycheck Amount</label>
                        <div class="relative mt-1">
                            <span class="absolute left-3 top-2 text-gray-400">$</span>
                            <input type="number" id="incomeAmount" class="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="2000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Frequency</label>
                        <select id="incomeFreq" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" onchange="toggleFreqInputs()">
                            <option value="bi-weekly">Bi-Weekly (Every 14 days)</option>
                            <option value="bi-monthly">Bi-Monthly (Fixed Dates)</option>
                        </select>
                    </div>

                    <!-- Dynamic Frequency Inputs -->
                    <div id="biWeeklyInput">
                        <label class="block text-xs font-medium text-gray-500 uppercase">Next Pay Date (Anchor)</label>
                        <input type="date" id="anchorDate" class="w-full mt-1 p-2 border rounded-lg outline-none">
                    </div>

                    <div id="biMonthlyInput" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">1st Pay Day</label>
                            <input type="number" id="payDay1" min="1" max="31" class="w-full mt-1 p-2 border rounded-lg" placeholder="1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">2nd Pay Day</label>
                            <input type="number" id="payDay2" min="1" max="31" class="w-full mt-1 p-2 border rounded-lg" placeholder="15">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bills Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-semibold text-gray-700"><i class="fas fa-file-invoice text-gray-500 mr-2"></i>Bills</h2>
                    <button onclick="addBillRow()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded transition"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="billsList" class="space-y-3">
                    <!-- Bills injected here -->
                </div>
            </div>

            <!-- Debts Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-semibold text-gray-700"><i class="fas fa-credit-card text-red-500 mr-2"></i>Debts</h2>
                    <button onclick="addDebtRow()" class="text-xs bg-red-50 hover:bg-red-100 text-red-600 px-2 py-1 rounded transition"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="debtsList" class="space-y-4">
                    <!-- Debts injected here -->
                </div>
            </div>

            <button onclick="saveData()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-semibold shadow-md transition transform active:scale-95">
                Update & Calculate
            </button>

        </div>

        <!-- RIGHT PANEL: Dashboard & Calendar -->
        <div class="w-full lg:w-2/3 flex flex-col space-y-6">
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Monthly Income (Est)</div>
                    <div class="text-2xl font-bold text-gray-800" id="totalMonthlyIncome">$0.00</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Total Commitments</div>
                    <div class="text-2xl font-bold text-gray-800" id="totalCommitments">$0.00</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Free Cash Flow</div>
                    <div class="text-2xl font-bold text-gray-800" id="freeCashFlow">$0.00</div>
                </div>
            </div>

            <!-- Calendar Controls -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex-grow flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800" id="currentMonthLabel">October 2023</h2>
                    <div class="flex space-x-2">
                        <button onclick="changeMonth(-1)" class="p-2 rounded hover:bg-gray-100 text-gray-600"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="changeMonth(1)" class="p-2 rounded hover:bg-gray-100 text-gray-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Calendar Header -->
                <div class="grid grid-cols-7 gap-0 bg-gray-50 text-center text-xs font-semibold text-gray-500 py-2 border-b">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>

                <!-- Calendar Grid -->
                <div id="calendarGrid" class="calendar-grid p-2 bg-gray-100 flex-grow h-full overflow-y-auto">
                    <!-- Calendar Days Generated Here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Event Details -->
    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal()"></div>
        
        <div class="modal-container bg-white w-11/12 md:w-1/2 mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold text-gray-800" id="modalTitle">Details</p>
                    <div class="cursor-pointer z-50" onclick="closeModal()">
                        <i class="fas fa-times text-gray-500 hover:text-gray-700"></i>
                    </div>
                </div>

                <!-- Body -->
                <div id="modalBody" class="my-5 space-y-4">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Templates for JS Injection -->
    <template id="billRowTemplate">
        <div class="bill-row grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded border border-gray-200">
            <div class="col-span-5">
                <input type="text" placeholder="Bill Name" class="bill-name w-full text-sm bg-transparent border-b border-dashed focus:border-indigo-500 outline-none">
            </div>
            <div class="col-span-3">
                <input type="number" placeholder="$" class="bill-amount w-full text-sm bg-transparent border-b border-dashed focus:border-indigo-500 outline-none">
            </div>
            <div class="col-span-3">
                <input type="number" placeholder="Day" min="1" max="31" class="bill-day w-full text-sm bg-transparent border-b border-dashed focus:border-indigo-500 outline-none">
            </div>
            <div class="col-span-1 text-center">
                <button onclick="this.closest('.bill-row').remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </template>

    <template id="debtRowTemplate">
        <div class="debt-row bg-red-50 p-3 rounded border border-red-100 space-y-2">
            <div class="grid grid-cols-2 gap-2">
                <input type="text" placeholder="Debt Name" class="debt-name w-full text-sm p-1 border rounded">
                <input type="number" placeholder="Balance" class="debt-balance w-full text-sm p-1 border rounded">
            </div>
            <div class="grid grid-cols-3 gap-2">
                <input type="number" placeholder="APR %" class="debt-apr w-full text-sm p-1 border rounded">
                <input type="number" placeholder="Min Pay" class="debt-min w-full text-sm p-1 border rounded">
                <input type="number" placeholder="Due Day" min="1" max="31" class="debt-day w-full text-sm p-1 border rounded">
            </div>
            <div class="text-right">
                <button onclick="this.closest('.debt-row').remove()" class="text-xs text-red-500 hover:underline">Remove</button>
            </div>
        </div>
    </template>

    <script>
        // --- State Management ---
        let appState = {
            income: {
                amount: 0,
                frequency: 'bi-weekly',
                anchorDate: '',
                payDay1: 1,
                payDay2: 15
            },
            bills: [],
            debts: [],
            viewDate: new Date()
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // If lists are empty, add one empty row to start
            if (document.querySelectorAll('.bill-row').length === 0) addBillRow();
            if (document.querySelectorAll('.debt-row').length === 0) addDebtRow();
            
            // Set view date to today
            appState.viewDate = new Date();
            
            // Render UI
            updateUI();
        });

        // --- DOM Helpers ---
        function toggleFreqInputs() {
            const freq = document.getElementById('incomeFreq').value;
            if (freq === 'bi-weekly') {
                document.getElementById('biWeeklyInput').classList.remove('hidden');
                document.getElementById('biMonthlyInput').classList.add('hidden');
            } else {
                document.getElementById('biWeeklyInput').classList.add('hidden');
                document.getElementById('biMonthlyInput').classList.remove('hidden');
            }
        }

        function addBillRow(data = null) {
            const template = document.getElementById('billRowTemplate');
            const clone = template.content.cloneNode(true);
            const list = document.getElementById('billsList');
            
            if (data) {
                clone.querySelector('.bill-name').value = data.name;
                clone.querySelector('.bill-amount').value = data.amount;
                clone.querySelector('.bill-day').value = data.day;
            }
            
            list.appendChild(clone);
        }

        function addDebtRow(data = null) {
            const template = document.getElementById('debtRowTemplate');
            const clone = template.content.cloneNode(true);
            const list = document.getElementById('debtsList');
            
            if (data) {
                clone.querySelector('.debt-name').value = data.name;
                clone.querySelector('.debt-balance').value = data.balance;
                clone.querySelector('.debt-apr').value = data.apr;
                clone.querySelector('.debt-min').value = data.minPayment;
                clone.querySelector('.debt-day').value = data.day;
            }

            list.appendChild(clone);
        }

        // --- Core Logic ---

        function saveData() {
            // Gather Income
            appState.income.amount = parseFloat(document.getElementById('incomeAmount').value) || 0;
            appState.income.frequency = document.getElementById('incomeFreq').value;
            appState.income.anchorDate = document.getElementById('anchorDate').value;
            appState.income.payDay1 = parseInt(document.getElementById('payDay1').value) || 1;
            appState.income.payDay2 = parseInt(document.getElementById('payDay2').value) || 15;

            // Gather Bills
            appState.bills = [];
            document.querySelectorAll('.bill-row').forEach(row => {
                const name = row.querySelector('.bill-name').value;
                const amount = parseFloat(row.querySelector('.bill-amount').value) || 0;
                const day = parseInt(row.querySelector('.bill-day').value) || 1;
                if (name) appState.bills.push({ name, amount, day });
            });

            // Gather Debts
            appState.debts = [];
            document.querySelectorAll('.debt-row').forEach(row => {
                const name = row.querySelector('.debt-name').value;
                const balance = parseFloat(row.querySelector('.debt-balance').value) || 0;
                const apr = parseFloat(row.querySelector('.debt-apr').value) || 0;
                const minPayment = parseFloat(row.querySelector('.debt-min').value) || 0;
                const day = parseInt(row.querySelector('.debt-day').value) || 1;
                if (name) appState.debts.push({ name, balance, apr, minPayment, day });
            });

            // Save to LocalStorage
            localStorage.setItem('financeApp_data', JSON.stringify(appState));
            
            updateUI();
        }

        function loadData() {
            const stored = localStorage.getItem('financeApp_data');
            if (stored) {
                const data = JSON.parse(stored);
                // Restore Income
                document.getElementById('incomeAmount').value = data.income.amount;
                document.getElementById('incomeFreq').value = data.income.frequency;
                document.getElementById('anchorDate').value = data.income.anchorDate;
                document.getElementById('payDay1').value = data.income.payDay1;
                document.getElementById('payDay2').value = data.income.payDay2;
                toggleFreqInputs();

                // Restore Bills
                document.getElementById('billsList').innerHTML = '';
                data.bills.forEach(b => addBillRow(b));

                // Restore Debts
                document.getElementById('debtsList').innerHTML = '';
                data.debts.forEach(d => addDebtRow(d));

                // Merge into current state
                appState = { ...appState, ...data };
            }
        }

        function updateUI() {
            renderDashboardStats();
            renderCalendar();
        }

        function renderDashboardStats() {
            // Very rough monthly estimation
            let monthlyIncome = 0;
            if (appState.income.frequency === 'bi-weekly') {
                monthlyIncome = appState.income.amount * 26 / 12; // Standard formula
            } else {
                monthlyIncome = appState.income.amount * 2;
            }

            let monthlyBills = appState.bills.reduce((sum, b) => sum + b.amount, 0);
            let monthlyDebtMin = appState.debts.reduce((sum, d) => sum + d.minPayment, 0);

            document.getElementById('totalMonthlyIncome').textContent = '$' + monthlyIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalCommitments').textContent = '$' + (monthlyBills + monthlyDebtMin).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('freeCashFlow').textContent = '$' + (monthlyIncome - monthlyBills - monthlyDebtMin).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- Calendar Logic ---

        function changeMonth(offset) {
            appState.viewDate.setMonth(appState.viewDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = appState.viewDate.getFullYear();
            const month = appState.viewDate.getMonth();
            
            // Header Label
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonthLabel').textContent = `${monthNames[month]} ${year}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding days from previous month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const cell = document.createElement('div');
                cell.className = 'bg-gray-200 h-24 md:h-32 rounded-lg opacity-50';
                grid.appendChild(cell);
            }

            // Generate Paydays for this month
            let payDates = [];
            if (appState.income.frequency === 'bi-monthly') {
                // Fixed dates logic
                payDates.push(new Date(year, month, appState.income.payDay1));
                payDates.push(new Date(year, month, appState.income.payDay2));
            } else if (appState.income.frequency === 'bi-weekly' && appState.income.anchorDate) {
                // 14-day loop logic
                let anchor = new Date(appState.income.anchorDate + 'T00:00:00'); // T00:00 to avoid timezone shift
                
                // Find first pay date relative to anchor
                // We back-calculate to find a paydate before the 1st of this month, then add 14 days until we pass end of month
                const msPerDay = 1000 * 60 * 60 * 24;
                const startOfMonth = new Date(year, month, 1);
                const endOfMonth = new Date(year, month + 1, 0);
                
                // Normalize anchor to start of day
                anchor.setHours(0,0,0,0);
                startOfMonth.setHours(0,0,0,0);

                // Calculate difference in days
                let diffDays = Math.floor((startOfMonth - anchor) / msPerDay);
                let remainder = diffDays % 14;
                
                // Adjust to align with the cycle
                let firstCycleDayInMonth;
                if (diffDays >= 0) {
                     // Anchor is in the past
                     let daysToAdd = (remainder === 0) ? 0 : (14 - remainder);
                     firstCycleDayInMonth = new Date(startOfMonth.getTime() + (daysToAdd * msPerDay));
                } else {
                    // Anchor is in future
                    // This logic simplifies finding the sync: just walk forward from anchor 
                    // (Note: For robust "past anchor" support, we use the modulo math above. 
                    // If simple, we can just loop from a far past date, but modulo is faster).
                    
                    // Fallback simple loop for user clarity if math fails edge cases:
                    let current = new Date(anchor);
                    while(current < startOfMonth) {
                        current.setDate(current.getDate() + 14);
                    }
                    firstCycleDayInMonth = current;
                }

                let pointer = new Date(firstCycleDayInMonth);
                while (pointer <= endOfMonth) {
                    if (pointer.getMonth() === month) {
                        payDates.push(new Date(pointer));
                    }
                    pointer.setDate(pointer.getDate() + 14);
                }
            }

            // Actual Calendar Cells
            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                const cell = document.createElement('div');
                cell.className = 'bg-white h-24 md:h-32 rounded-lg border border-gray-200 p-1 flex flex-col relative hover:shadow-md transition overflow-hidden cursor-pointer';
                cell.onclick = (e) => {
                    // Prevent triggering if clicking specific items
                    if(e.target === cell || e.target.classList.contains('day-num')) {
                       // Could open day summary
                    }
                };

                // Date Number
                cell.innerHTML = `<span class="day-num text-xs font-bold text-gray-500 mb-1 block">${d}</span>`;
                
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'flex flex-col gap-1 overflow-y-auto custom-scrollbar h-full';
                cell.appendChild(eventsContainer);

                // Check Payday
                const isPayDay = payDates.some(pd => pd.getDate() === d);
                if (isPayDay) {
                    const payPill = document.createElement('div');
                    payPill.className = 'bg-green-100 border border-green-300 text-green-700 text-[10px] px-1 rounded font-bold truncate cursor-pointer hover:bg-green-200';
                    payPill.innerHTML = `<i class="fas fa-money-bill-wave"></i> Payday`;
                    payPill.onclick = (e) => {
                        e.stopPropagation();
                        showPayPeriodDetails(cellDate, payDates);
                    };
                    eventsContainer.appendChild(payPill);
                }

                // Check Bills
                appState.bills.forEach(bill => {
                    if (bill.day === d) {
                        const billDot = document.createElement('div');
                        billDot.className = 'bg-gray-100 text-gray-600 text-[10px] px-1 rounded truncate border border-gray-300';
                        billDot.textContent = `${bill.name} -$${bill.amount}`;
                        eventsContainer.appendChild(billDot);
                    }
                });

                // Check Debts
                appState.debts.forEach(debt => {
                    if (debt.day === d) {
                        const debtPill = document.createElement('div');
                        debtPill.className = 'bg-red-100 border border-red-300 text-red-700 text-[10px] px-1 rounded font-bold truncate cursor-pointer hover:bg-red-200';
                        debtPill.textContent = `${debt.name} Due`;
                        debtPill.onclick = (e) => {
                            e.stopPropagation();
                            showDebtProjection(debt, cellDate);
                        };
                        eventsContainer.appendChild(debtPill);
                    }
                });

                grid.appendChild(cell);
            }
        }

        // --- Details & Projection Logic ---

        function showPayPeriodDetails(payDate, allPayDates) {
            // Calculate period: from this payDate until the next one
            // Sort pay dates to find next one
            const sortedPayDates = [...allPayDates].sort((a,b) => a - b);
            const currentIndex = sortedPayDates.findIndex(pd => pd.getDate() === payDate.getDate());
            
            // Determine range
            const startDate = new Date(payDate);
            let endDate = new Date(payDate);
            
            if (currentIndex < sortedPayDates.length - 1) {
                // Ends day before next check
                endDate = new Date(sortedPayDates[currentIndex + 1]);
                endDate.setDate(endDate.getDate() - 1);
            } else {
                // Last check of month, estimate end (e.g. +13 days or end of month)
                if (appState.income.frequency === 'bi-weekly') {
                    endDate.setDate(endDate.getDate() + 13);
                } else {
                    // Bi-monthly logic approximation
                    endDate.setDate(endDate.getDate() + 14); 
                }
            }

            // Find expenses in this range
            let expensesTotal = 0;
            let items = [];

            // Scan days in range
            let scanDate = new Date(startDate);
            while (scanDate <= endDate) {
                const day = scanDate.getDate();
                
                // Bills
                appState.bills.forEach(b => {
                    if(b.day === day) {
                        items.push({type: 'Bill', name: b.name, amount: b.amount, date: new Date(scanDate)});
                        expensesTotal += b.amount;
                    }
                });

                // Debts
                appState.debts.forEach(d => {
                    if(d.day === day) {
                        items.push({type: 'Debt', name: d.name, amount: d.minPayment, date: new Date(scanDate)});
                        expensesTotal += d.minPayment;
                    }
                });

                scanDate.setDate(scanDate.getDate() + 1);
            }

            const surplus = appState.income.amount - expensesTotal;
            const statusColor = surplus >= 0 ? 'text-green-600' : 'text-red-600';

            const html = `
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="text-sm text-gray-500 mb-1">Pay Period</div>
                    <div class="font-bold text-lg">${startDate.toLocaleDateString()} â€” ${endDate.toLocaleDateString()}</div>
                </div>

                <div class="space-y-2 mb-4">
                    <div class="flex justify-between border-b pb-1">
                        <span>Income</span>
                        <span class="font-semibold text-green-600">+$${appState.income.amount.toFixed(2)}</span>
                    </div>
                    ${items.map(i => `
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${i.date.getDate()} - ${i.name}</span>
                            <span>-$${i.amount.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                    <span class="font-bold text-gray-700">Safe to Spend:</span>
                    <span class="font-bold text-xl ${statusColor}">$${surplus.toFixed(2)}</span>
                </div>
            `;

            openModal('Budget Snapshot', html);
        }

        function showDebtProjection(debt, targetDate) {
            // Calculate how many months/payments between NOW and Target Date
            const now = new Date();
            // Reset times
            now.setHours(0,0,0,0);
            targetDate.setHours(0,0,0,0);

            // Simple month diff calculation
            let monthsDiff = (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth());
            
            // If target date day is AFTER due date in that month, count it as a payment month
            // Actually, let's just simulate month by month
            
            let simulatedBalance = debt.balance;
            let totalInterest = 0;
            let monthlyRate = (debt.apr / 100) / 12;

            // We simulate from "Now" until the "Target Date"
            // For every month passed, we accrue interest and subtract payment
            
            // Clamp negative months (past) to 0
            if (monthsDiff < 0) monthsDiff = 0;

            for(let i = 0; i < monthsDiff; i++) {
                let interest = simulatedBalance * monthlyRate;
                totalInterest += interest;
                // Assuming minimum payment covers at least interest, usually
                let principal = debt.minPayment - interest;
                simulatedBalance -= principal;
            }

            // Calculate for the Specific Target Payment
            let currentInterest = simulatedBalance * monthlyRate;
            let currentPrincipal = debt.minPayment - currentInterest;
            let balanceAfterPayment = simulatedBalance - currentPrincipal;

            const html = `
                <div class="space-y-4">
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                        <div class="text-xs text-red-500 uppercase font-bold">Current Status</div>
                        <div class="text-xl font-bold text-gray-800">${debt.name}</div>
                        <div class="text-sm text-gray-600">APR: ${debt.apr}%</div>
                    </div>

                    <div class="relative pt-4">
                        <div class="border-l-2 border-gray-200 pl-4 space-y-6">
                            
                            <!-- Timeline Item -->
                            <div>
                                <div class="text-xs font-bold text-gray-400">BY THIS DATE</div>
                                <div class="text-gray-800 font-semibold">Interest Accrued (Est): <span class="text-red-500">$${totalInterest.toFixed(2)}</span></div>
                            </div>

                            <!-- Timeline Item -->
                            <div>
                                <div class="text-xs font-bold text-gray-400">THIS PAYMENT</div>
                                <div class="grid grid-cols-2 gap-2 text-sm mt-1">
                                    <div class="bg-gray-100 p-2 rounded">
                                        <div class="text-gray-500 text-xs">Interest Part</div>
                                        <div class="font-bold text-red-600">$${currentInterest.toFixed(2)}</div>
                                    </div>
                                    <div class="bg-gray-100 p-2 rounded">
                                        <div class="text-gray-500 text-xs">Principal Part</div>
                                        <div class="font-bold text-green-600">$${currentPrincipal.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Result -->
                            <div>
                                <div class="text-xs font-bold text-gray-400">PROJECTED BALANCE</div>
                                <div class="text-3xl font-bold text-gray-800">$${balanceAfterPayment.toFixed(2)}</div>
                                <div class="text-xs text-gray-400 mt-1">Assuming only minimum payments made until this date.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            openModal('Debt Projection', html);
        }

        // --- Modal Utils ---
        function openModal(title, htmlContent) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = htmlContent;
            
            const modal = document.getElementById('detailModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        // Close on escape
        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.keyCode == 27) {
                closeModal();
            }
        };

    </script>
</body>
</html>